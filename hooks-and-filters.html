<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Hooks and Filters - Writing Anki Add-ons</title>
        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="support.html"><strong aria-hidden="true">2.</strong> Support</a></li><li class="chapter-item expanded "><a href="editor-setup.html"><strong aria-hidden="true">3.</strong> Editor Setup</a></li><li class="chapter-item expanded "><a href="mypy.html"><strong aria-hidden="true">4.</strong> MyPy</a></li><li class="chapter-item expanded "><a href="addon-folders.html"><strong aria-hidden="true">5.</strong> Add-on Folders</a></li><li class="chapter-item expanded "><a href="a-basic-addon.html"><strong aria-hidden="true">6.</strong> A Basic Add-on</a></li><li class="chapter-item expanded "><a href="the-anki-module.html"><strong aria-hidden="true">7.</strong> The 'anki' Module</a></li><li class="chapter-item expanded "><a href="hooks-and-filters.html" class="active"><strong aria-hidden="true">8.</strong> Hooks and Filters</a></li><li class="chapter-item expanded "><a href="background-ops.html"><strong aria-hidden="true">9.</strong> Background Operations</a></li><li class="chapter-item expanded "><a href="qt.html"><strong aria-hidden="true">10.</strong> Qt and PyQt</a></li><li class="chapter-item expanded "><a href="python-modules.html"><strong aria-hidden="true">11.</strong> Python Modules</a></li><li class="chapter-item expanded "><a href="addon-config.html"><strong aria-hidden="true">12.</strong> Add-on Config</a></li><li class="chapter-item expanded "><a href="reviewer-javascript.html"><strong aria-hidden="true">13.</strong> Reviewer Javascript</a></li><li class="chapter-item expanded "><a href="debugging.html"><strong aria-hidden="true">14.</strong> Debugging</a></li><li class="chapter-item expanded "><a href="monkey-patching.html"><strong aria-hidden="true">15.</strong> Monkey Patching</a></li><li class="chapter-item expanded "><a href="sharing.html"><strong aria-hidden="true">16.</strong> Sharing Add-ons</a></li><li class="chapter-item expanded "><a href="porting2.0.html"><strong aria-hidden="true">17.</strong> Porting 2.0 Add-ons</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Writing Anki Add-ons</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/ankitects/addon-docs/" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="hooks--filters"><a class="header" href="#hooks--filters">Hooks &amp; Filters</a></h1>
<ul>
<li><a href="#new-style-hooks">New Style Hooks</a></li>
<li><a href="#notable-hooks">Notable Hooks</a>
<ul>
<li><a href="#webview">Webview</a></li>
</ul>
</li>
<li><a href="#legacy-hook-handling">Legacy Hook Handling</a></li>
<li><a href="#adding-hooks">Adding Hooks</a></li>
</ul>
<p>Hooks are the way you should connect your add-on code to Anki. If the
function you want to alter doesn’t already have a hook, please see the
section below about adding new hooks.</p>
<p>There are two different kinds of &quot;hooks&quot;:</p>
<ul>
<li>
<p>Regular hooks are functions that don’t return anything. They are run
for their side effects, and may sometimes alter the objects they
have been passed, such as inserting an extra item in a list.</p>
</li>
<li>
<p>&quot;Filters&quot; are functions that return their first argument, after
maybe changing it. An example filter is one that takes the text of a
field during card display, and returns an altered version.</p>
</li>
</ul>
<p>The distinction is necessary because some data types in Python can be
modified directly, and others can only be modified by creating a changed
copy (such as strings).</p>
<h2 id="new-style-hooks"><a class="header" href="#new-style-hooks">New Style Hooks</a></h2>
<p>A new style of hook was added in Anki 2.1.20.</p>
<p>Imagine you wish to show a message each time the front side of a card is
shown in the review screen. You’ve looked at the source code in
reviewer.py, and seen the following line in the showQuestion() function:</p>
<pre><code class="language-python">gui_hooks.reviewer_did_show_question(card)
</code></pre>
<p>To register a function to be called when this hook is run, you can do
the following in your add-on:</p>
<pre><code class="language-python">from aqt import gui_hooks

def myfunc(card):
  print(&quot;question shown, card question is:&quot;, card.q())

gui_hooks.reviewer_did_show_question.append(myfunc)
</code></pre>
<p>Multiple add-ons can register for the same hook or filter - they will
all be called in turn.</p>
<p>To remove a hook, use code like:</p>
<pre><code>gui_hooks.reviewer_did_show_question.remove(myfunc)
</code></pre>
<p>:warning: Functions you attach to a hook should not modify the hook while they are executing, as it will break things:</p>
<pre><code>def myfunc(card):
  # DON'T DO THIS!
  gui_hooks.reviewer_did_show_question.remove(myfunc)

gui_hooks.reviewer_did_show_question.append(myfunc)
</code></pre>
<p>An easy way to see all hooks at a glance is to look at
pylib/tools/genhooks.py and qt/tools/genhooks_gui.py.</p>
<p>If you have set up type completion as described in an earlier section,
you can also see the hooks in your IDE:</p>
<video controls autoplay loop muted>
 <source src="../img/autocomplete.mp4" type="video/mp4">
</video>
<p>In the above video, holding the command/ctrl key down while hovering
will show a tooltip, including arguments and documentation if it exists.
The argument names and types for the callback can be seen on the bottom
line.</p>
<p>For some examples of how the new hooks are used, please see
<a href="https://github.com/ankitects/anki-addons/blob/master/demos/">https://github.com/ankitects/anki-addons/blob/master/demos/</a>.</p>
<p>Most of the new style hooks will also call the legacy hooks (described
further below), so old add-ons will continue to work for now, but add-on authors
are encouraged to update to the new style as it allows for code
completion, and better error checking.</p>
<h2 id="notable-hooks"><a class="header" href="#notable-hooks">Notable Hooks</a></h2>
<p>For a full list of hooks, and their documentation, please see</p>
<ul>
<li><a href="https://github.com/ankitects/anki/blob/master/qt/tools/genhooks_gui.py">The GUI hooks</a></li>
<li><a href="https://github.com/ankitects/anki/blob/master/pylib/tools/genhooks.py">The pylib hooks</a></li>
</ul>
<h3 id="webview"><a class="header" href="#webview">Webview</a></h3>
<p>Many of Anki's screens are built with one or more webviews, and there are
some hooks you can use to intercept their use.</p>
<p>From Anki 2.1.22:</p>
<ul>
<li><code>gui_hooks.webview_will_set_content()</code> allows you to modify the HTML that
various screens send to the webview. You can use this for adding your own
HTML/CSS/Javascript to particular screens. This will not work for external
pages - see the Anki 2.1.36 section below.</li>
<li><code>gui_hooks.webview_did_receive_js_message()</code> allows you to intercept
messages sent from Javascript. Anki provides a <code>pycmd(string)</code> function in
Javascript which sends a message back to Python, and various screens such as
reviewer.py respond to the messages. By using this hook, you can respond
to your own messages as well.</li>
</ul>
<p>From Anki 2.1.36:</p>
<ul>
<li><code>webview_did_inject_style_into_page()</code> gives you an opportunity to inject
styling or content into external pages like the graphs screen and congratulations
page that are loaded with load_ts_page().</li>
</ul>
<h2 id="legacy-hook-handling"><a class="header" href="#legacy-hook-handling">Legacy Hook Handling</a></h2>
<p>Older versions of Anki used a different hook system, using the functions
runHook(), addHook() and runFilter().</p>
<p>For example, when the scheduler (anki/sched.py) discovers a leech, it
calls:</p>
<pre><code class="language-python">runHook(&quot;leech&quot;, card)
</code></pre>
<p>If you wished to perform a special operation when a leech was
discovered, such as moving the card to a &quot;Difficult&quot; deck, you could do
it with the following code:</p>
<pre><code class="language-python">from anki.hooks import addHook
from aqt import mw

def onLeech(card):
    # can modify without .flush(), as scheduler will do it for us
    card.did = mw.col.decks.id(&quot;Difficult&quot;)
    # if the card was in a cram deck, we have to put back the original due
    # time and original deck
    card.odid = 0
    if card.odue:
        card.due = card.odue
        card.odue = 0

addHook(&quot;leech&quot;, onLeech)
</code></pre>
<p>An example of a filter is in aqt/editor.py. The editor calls the
&quot;editFocusLost&quot; filter each time a field loses focus, so that add-ons
can apply changes to the note:</p>
<pre><code class="language-python">if runFilter(
    &quot;editFocusLost&quot;, False, self.note, self.currentField):
    # something updated the note; schedule reload
    def onUpdate():
        self.loadNote()
        self.checkValid()
    self.mw.progress.timer(100, onUpdate, False)
</code></pre>
<p>Each filter in this example accepts three arguments: a modified flag,
the note, and the current field. If a filter makes no changes it returns
the modified flag the same as it received it; if it makes a change it
returns True. In this way, if any single add-on makes a change, the UI
will reload the note to show updates.</p>
<p>The Japanese Support add-on uses this hook to automatically generate one
field from another. A slightly simplified version is presented below:</p>
<pre><code class="language-python">def onFocusLost(flag, n, fidx):
    from aqt import mw
    # japanese model?
    if &quot;japanese&quot; not in n.model()['name'].lower():
        return flag
    # have src and dst fields?
    for c, name in enumerate(mw.col.models.fieldNames(n.model())):
        for f in srcFields:
            if name == f:
                src = f
                srcIdx = c
        for f in dstFields:
            if name == f:
                dst = f
    if not src or not dst:
        return flag
    # dst field already filled?
    if n[dst]:
        return flag
    # event coming from src field?
    if fidx != srcIdx:
        return flag
    # grab source text
    srcTxt = mw.col.media.strip(n[src])
    if not srcTxt:
        return flag
    # update field
    try:
        n[dst] = mecab.reading(srcTxt)
    except Exception, e:
        mecab = None
        raise
    return True

addHook('editFocusLost', onFocusLost)
</code></pre>
<p>The first argument of a filter is the argument that should be returned.
In the focus lost filter this is a flag, but in other cases it may be
some other object. For example, in anki/collection.py, _renderQA()
calls the &quot;mungeQA&quot; filter which contains the generated HTML for the
front and back of cards. latex.py uses this filter to convert text in
LaTeX tags into images.</p>
<p>In Anki 2.1, a hook was added for adding buttons to the editor. It can
be used like so:</p>
<pre><code class="language-python">from aqt.utils import showInfo
from anki.hooks import addHook

# cross out the currently selected text
def onStrike(editor):
    editor.web.eval(&quot;wrap('&lt;del&gt;', '&lt;/del&gt;');&quot;)

def addMyButton(buttons, editor):
    editor._links['strike'] = onStrike
    return buttons + [editor._addButton(
        &quot;iconname&quot;, # &quot;/full/path/to/icon.png&quot;,
        &quot;strike&quot;, # link name
        &quot;tooltip&quot;)]

addHook(&quot;setupEditorButtons&quot;, addMyButton)
</code></pre>
<h2 id="adding-hooks"><a class="header" href="#adding-hooks">Adding Hooks</a></h2>
<p>If you want to modify a function that doesn’t already have a hook,
please submit a pull request that adds the hooks you need.</p>
<p>The hook definitions are located in <code>pylib/tools/genhooks.py</code> and
<code>qt/tools/genhooks_gui.py</code>. When building Anki, the build scripts will
automatically update the hook files with the definitions listed there.</p>
<p>Please see the docs/ folder in the source tree for more information.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="the-anki-module.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="background-ops.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="the-anki-module.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="background-ops.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
